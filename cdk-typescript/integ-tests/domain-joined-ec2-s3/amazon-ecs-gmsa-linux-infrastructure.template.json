{
 "Resources": {
  "vpcA2121C38": {
   "Type": "AWS::EC2::VPC",
   "Properties": {
    "CidrBlock": "10.0.0.0/26",
    "EnableDnsHostnames": true,
    "EnableDnsSupport": true,
    "InstanceTenancy": "default",
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/Resource"
   }
  },
  "vpcPublicSubnet1Subnet2E65531E": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": {
     "Fn::Select": [
      0,
      {
       "Fn::GetAZs": ""
      }
     ]
    },
    "CidrBlock": "10.0.0.0/28",
    "MapPublicIpOnLaunch": true,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Public"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Public"
     },
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "vpcA2121C38"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet1/Subnet"
   }
  },
  "vpcPublicSubnet1RouteTable48A2DF9B": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "vpcA2121C38"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet1/RouteTable"
   }
  },
  "vpcPublicSubnet1RouteTableAssociation5D3F4579": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "vpcPublicSubnet1RouteTable48A2DF9B"
    },
    "SubnetId": {
     "Ref": "vpcPublicSubnet1Subnet2E65531E"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet1/RouteTableAssociation"
   }
  },
  "vpcPublicSubnet1DefaultRoute10708846": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "GatewayId": {
     "Ref": "vpcIGWE57CBDCA"
    },
    "RouteTableId": {
     "Ref": "vpcPublicSubnet1RouteTable48A2DF9B"
    }
   },
   "DependsOn": [
    "vpcVPCGW7984C166"
   ],
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet1/DefaultRoute"
   }
  },
  "vpcPublicSubnet1EIPDA49DCBE": {
   "Type": "AWS::EC2::EIP",
   "Properties": {
    "Domain": "vpc",
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet1"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet1/EIP"
   }
  },
  "vpcPublicSubnet1NATGateway9C16659E": {
   "Type": "AWS::EC2::NatGateway",
   "Properties": {
    "AllocationId": {
     "Fn::GetAtt": [
      "vpcPublicSubnet1EIPDA49DCBE",
      "AllocationId"
     ]
    },
    "SubnetId": {
     "Ref": "vpcPublicSubnet1Subnet2E65531E"
    },
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet1"
     }
    ]
   },
   "DependsOn": [
    "vpcPublicSubnet1DefaultRoute10708846",
    "vpcPublicSubnet1RouteTableAssociation5D3F4579"
   ],
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet1/NATGateway"
   }
  },
  "vpcPublicSubnet2Subnet009B674F": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": {
     "Fn::Select": [
      1,
      {
       "Fn::GetAZs": ""
      }
     ]
    },
    "CidrBlock": "10.0.0.16/28",
    "MapPublicIpOnLaunch": true,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Public"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Public"
     },
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "vpcA2121C38"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet2/Subnet"
   }
  },
  "vpcPublicSubnet2RouteTableEB40D4CB": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "vpcA2121C38"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet2/RouteTable"
   }
  },
  "vpcPublicSubnet2RouteTableAssociation21F81B59": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "vpcPublicSubnet2RouteTableEB40D4CB"
    },
    "SubnetId": {
     "Ref": "vpcPublicSubnet2Subnet009B674F"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet2/RouteTableAssociation"
   }
  },
  "vpcPublicSubnet2DefaultRouteA1EC0F60": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "GatewayId": {
     "Ref": "vpcIGWE57CBDCA"
    },
    "RouteTableId": {
     "Ref": "vpcPublicSubnet2RouteTableEB40D4CB"
    }
   },
   "DependsOn": [
    "vpcVPCGW7984C166"
   ],
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet2/DefaultRoute"
   }
  },
  "vpcPublicSubnet2EIP9B3743B1": {
   "Type": "AWS::EC2::EIP",
   "Properties": {
    "Domain": "vpc",
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet2"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet2/EIP"
   }
  },
  "vpcPublicSubnet2NATGateway9B8AE11A": {
   "Type": "AWS::EC2::NatGateway",
   "Properties": {
    "AllocationId": {
     "Fn::GetAtt": [
      "vpcPublicSubnet2EIP9B3743B1",
      "AllocationId"
     ]
    },
    "SubnetId": {
     "Ref": "vpcPublicSubnet2Subnet009B674F"
    },
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet2"
     }
    ]
   },
   "DependsOn": [
    "vpcPublicSubnet2DefaultRouteA1EC0F60",
    "vpcPublicSubnet2RouteTableAssociation21F81B59"
   ],
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PublicSubnet2/NATGateway"
   }
  },
  "vpcPrivateSubnet1Subnet934893E8": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": {
     "Fn::Select": [
      0,
      {
       "Fn::GetAZs": ""
      }
     ]
    },
    "CidrBlock": "10.0.0.32/28",
    "MapPublicIpOnLaunch": false,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Private"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Private"
     },
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/PrivateSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "vpcA2121C38"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PrivateSubnet1/Subnet"
   }
  },
  "vpcPrivateSubnet1RouteTableB41A48CC": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/PrivateSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "vpcA2121C38"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PrivateSubnet1/RouteTable"
   }
  },
  "vpcPrivateSubnet1RouteTableAssociation67945127": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "vpcPrivateSubnet1RouteTableB41A48CC"
    },
    "SubnetId": {
     "Ref": "vpcPrivateSubnet1Subnet934893E8"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PrivateSubnet1/RouteTableAssociation"
   }
  },
  "vpcPrivateSubnet1DefaultRoute1AA8E2E5": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "NatGatewayId": {
     "Ref": "vpcPublicSubnet1NATGateway9C16659E"
    },
    "RouteTableId": {
     "Ref": "vpcPrivateSubnet1RouteTableB41A48CC"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PrivateSubnet1/DefaultRoute"
   }
  },
  "vpcPrivateSubnet2Subnet7031C2BA": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": {
     "Fn::Select": [
      1,
      {
       "Fn::GetAZs": ""
      }
     ]
    },
    "CidrBlock": "10.0.0.48/28",
    "MapPublicIpOnLaunch": false,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Private"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Private"
     },
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/PrivateSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "vpcA2121C38"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PrivateSubnet2/Subnet"
   }
  },
  "vpcPrivateSubnet2RouteTable7280F23E": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/PrivateSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "vpcA2121C38"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PrivateSubnet2/RouteTable"
   }
  },
  "vpcPrivateSubnet2RouteTableAssociation007E94D3": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "vpcPrivateSubnet2RouteTable7280F23E"
    },
    "SubnetId": {
     "Ref": "vpcPrivateSubnet2Subnet7031C2BA"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PrivateSubnet2/RouteTableAssociation"
   }
  },
  "vpcPrivateSubnet2DefaultRouteB0E07F99": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "NatGatewayId": {
     "Ref": "vpcPublicSubnet2NATGateway9B8AE11A"
    },
    "RouteTableId": {
     "Ref": "vpcPrivateSubnet2RouteTable7280F23E"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/PrivateSubnet2/DefaultRoute"
   }
  },
  "vpcIGWE57CBDCA": {
   "Type": "AWS::EC2::InternetGateway",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/IGW"
   }
  },
  "vpcVPCGW7984C166": {
   "Type": "AWS::EC2::VPCGatewayAttachment",
   "Properties": {
    "InternetGatewayId": {
     "Ref": "vpcIGWE57CBDCA"
    },
    "VpcId": {
     "Ref": "vpcA2121C38"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/VPCGW"
   }
  },
  "vpcFlowLogCloudWatchIAMRoleF5137BA9": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "vpc-flow-logs.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/FlowLogCloudWatch"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/FlowLogCloudWatch/IAMRole/Resource"
   }
  },
  "vpcFlowLogCloudWatchIAMRoleDefaultPolicy81671661": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "logs:CreateLogStream",
        "logs:DescribeLogStreams",
        "logs:PutLogEvents"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "vpcFlowLogCloudWatchLogGroup6B336362",
         "Arn"
        ]
       }
      },
      {
       "Action": "iam:PassRole",
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "vpcFlowLogCloudWatchIAMRoleF5137BA9",
         "Arn"
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "vpcFlowLogCloudWatchIAMRoleDefaultPolicy81671661",
    "Roles": [
     {
      "Ref": "vpcFlowLogCloudWatchIAMRoleF5137BA9"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/FlowLogCloudWatch/IAMRole/DefaultPolicy/Resource"
   }
  },
  "vpcFlowLogCloudWatchLogGroup6B336362": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "RetentionInDays": 731,
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/FlowLogCloudWatch"
     }
    ]
   },
   "UpdateReplacePolicy": "Retain",
   "DeletionPolicy": "Retain",
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/FlowLogCloudWatch/LogGroup/Resource"
   }
  },
  "vpcFlowLogCloudWatchFlowLog27550298": {
   "Type": "AWS::EC2::FlowLog",
   "Properties": {
    "DeliverLogsPermissionArn": {
     "Fn::GetAtt": [
      "vpcFlowLogCloudWatchIAMRoleF5137BA9",
      "Arn"
     ]
    },
    "LogDestinationType": "cloud-watch-logs",
    "LogGroupName": {
     "Ref": "vpcFlowLogCloudWatchLogGroup6B336362"
    },
    "ResourceId": {
     "Ref": "vpcA2121C38"
    },
    "ResourceType": "VPC",
    "Tags": [
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/vpc/FlowLogCloudWatch"
     }
    ],
    "TrafficType": "REJECT"
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/vpc/FlowLogCloudWatch/FlowLog"
   }
  },
  "activedirectoryadminpasswordsecretB1F8F377": {
   "Type": "AWS::SecretsManager::Secret",
   "Properties": {
    "GenerateSecretString": {
     "ExcludeCharacters": "\"'"
    },
    "Name": "amazon-ecs-gmsa-linux/active-directory-administrator-password"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/active-directory-admin-password-secret/Resource"
   }
  },
  "activedirectory": {
   "Type": "AWS::DirectoryService::MicrosoftAD",
   "Properties": {
    "Edition": "Standard",
    "Name": "directory.amazon-ecs-gmsa-linux.com",
    "Password": {
     "Fn::Join": [
      "",
      [
       "{{resolve:secretsmanager:",
       {
        "Ref": "activedirectoryadminpasswordsecretB1F8F377"
       },
       ":SecretString:::}}"
      ]
     ]
    },
    "VpcSettings": {
     "SubnetIds": [
      {
       "Ref": "vpcPrivateSubnet1Subnet934893E8"
      },
      {
       "Ref": "vpcPrivateSubnet2Subnet7031C2BA"
      }
     ],
     "VpcId": {
      "Ref": "vpcA2121C38"
     }
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/active-directory"
   }
  },
  "activedirectoryidssmparameter08CA1094": {
   "Type": "AWS::SSM::Parameter",
   "Properties": {
    "AllowedPattern": ".*",
    "Description": "Active Directory ID",
    "Name": "/amazon-ecs-gmsa-linux/active-directory-id",
    "Tier": "Standard",
    "Type": "String",
    "Value": {
     "Fn::GetAtt": [
      "activedirectory",
      "Alias"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/active-directory-id-ssm-parameter/Resource"
   }
  },
  "activedirectorydhcpops": {
   "Type": "AWS::EC2::DHCPOptions",
   "Properties": {
    "DomainName": "directory.amazon-ecs-gmsa-linux.com",
    "DomainNameServers": {
     "Fn::GetAtt": [
      "activedirectory",
      "DnsIpAddresses"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/active-directory-dhcp-ops"
   }
  },
  "directorydhcpopsassociation": {
   "Type": "AWS::EC2::VPCDHCPOptionsAssociation",
   "Properties": {
    "DhcpOptionsId": {
     "Ref": "activedirectorydhcpops"
    },
    "VpcId": {
     "Ref": "vpcA2121C38"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/directory-dhcp-ops-association"
   }
  },
  "ecscluster7830E7B5": {
   "Type": "AWS::ECS::Cluster",
   "Properties": {
    "ClusterName": "amazon-ecs-gmsa-linux",
    "ClusterSettings": [
     {
      "Name": "containerInsights",
      "Value": "enabled"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster/Resource"
   }
  },
  "ecsclusterB48992C7": {
   "Type": "AWS::ECS::ClusterCapacityProviderAssociations",
   "Properties": {
    "CapacityProviders": [
     {
      "Ref": "ecsclusterasgcapacityprovider4923E7E5"
     }
    ],
    "Cluster": {
     "Ref": "ecscluster7830E7B5"
    },
    "DefaultCapacityProviderStrategy": []
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster/ecs-cluster"
   }
  },
  "credfetcheridentitysecretFEBFB2F2": {
   "Type": "AWS::SecretsManager::Secret",
   "Properties": {
    "GenerateSecretString": {
     "ExcludeCharacters": "\"'",
     "GenerateStringKey": "password",
     "SecretStringTemplate": "{\"username\":\"SampleWebAppUser\",\"domainName\":\"directory.amazon-ecs-gmsa-linux.com\"}"
    },
    "Name": "amazon-ecs-gmsa-linux/credentials-fetcher-identity"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/cred-fetcher-identity-secret/Resource"
   }
  },
  "domainjoinssmdocument": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "schemaVersion": "2.2",
     "description": "Joins an EC2 instance to the directory.amazon-ecs-gmsa-linux.com domain using seamless joining",
     "mainSteps": [
      {
       "action": "aws:domainJoin",
       "name": "domainJoin",
       "inputs": {
        "directoryId": {
         "Fn::GetAtt": [
          "activedirectory",
          "Alias"
         ]
        },
        "directoryName": "directory.amazon-ecs-gmsa-linux.com"
       }
      }
     ]
    },
    "DocumentType": "Command"
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/domain-join-ssm-document"
   }
  },
  "activedirectoryseamlessjoinsecret9100DD98": {
   "Type": "AWS::SecretsManager::Secret",
   "Properties": {
    "Name": {
     "Fn::Join": [
      "",
      [
       "aws/directory-services/",
       {
        "Fn::GetAtt": [
         "activedirectory",
         "Alias"
        ]
       },
       "/seamless-domain-join"
      ]
     ]
    },
    "SecretString": {
     "Fn::Join": [
      "",
      [
       "{\"awsSeamlessDomainUsername\":\"admin\",\"awsSeamlessDomainPassword\":\"{{resolve:secretsmanager:",
       {
        "Ref": "activedirectoryadminpasswordsecretB1F8F377"
       },
       ":SecretString:::}}\"}"
      ]
     ]
    }
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/active-directory-seamless-join-secret/Resource"
   }
  },
  "domainjoinssmdocumentalt": {
   "Type": "AWS::SSM::Document",
   "Properties": {
    "Content": {
     "schemaVersion": "2.2",
     "description": "Joins an ECS container instance to the directory.amazon-ecs-gmsa-linux.com domain using the realm CLI",
     "mainSteps": [
      {
       "action": "aws:runShellScript",
       "name": "domainJoinEcs",
       "inputs": {
        "timeoutSeconds": "160",
        "runCommand": [
         "echo \"Waiting 80 seconds...\"",
         "sleep 80s",
         "dnf install jq -y",
         "echo \"Retrieving AD admin password...\"",
         {
          "Fn::Join": [
           "",
           [
            "adAdminPassword=$(aws secretsmanager get-secret-value --secret-id ",
            {
             "Fn::Join": [
              "-",
              [
               {
                "Fn::Select": [
                 0,
                 {
                  "Fn::Split": [
                   "-",
                   {
                    "Fn::Select": [
                     6,
                     {
                      "Fn::Split": [
                       ":",
                       {
                        "Ref": "activedirectoryadminpasswordsecretB1F8F377"
                       }
                      ]
                     }
                    ]
                   }
                  ]
                 }
                ]
               },
               {
                "Fn::Select": [
                 1,
                 {
                  "Fn::Split": [
                   "-",
                   {
                    "Fn::Select": [
                     6,
                     {
                      "Fn::Split": [
                       ":",
                       {
                        "Ref": "activedirectoryadminpasswordsecretB1F8F377"
                       }
                      ]
                     }
                    ]
                   }
                  ]
                 }
                ]
               },
               {
                "Fn::Select": [
                 2,
                 {
                  "Fn::Split": [
                   "-",
                   {
                    "Fn::Select": [
                     6,
                     {
                      "Fn::Split": [
                       ":",
                       {
                        "Ref": "activedirectoryadminpasswordsecretB1F8F377"
                       }
                      ]
                     }
                    ]
                   }
                  ]
                 }
                ]
               },
               {
                "Fn::Select": [
                 3,
                 {
                  "Fn::Split": [
                   "-",
                   {
                    "Fn::Select": [
                     6,
                     {
                      "Fn::Split": [
                       ":",
                       {
                        "Ref": "activedirectoryadminpasswordsecretB1F8F377"
                       }
                      ]
                     }
                    ]
                   }
                  ]
                 }
                ]
               },
               {
                "Fn::Select": [
                 4,
                 {
                  "Fn::Split": [
                   "-",
                   {
                    "Fn::Select": [
                     6,
                     {
                      "Fn::Split": [
                       ":",
                       {
                        "Ref": "activedirectoryadminpasswordsecretB1F8F377"
                       }
                      ]
                     }
                    ]
                   }
                  ]
                 }
                ]
               },
               {
                "Fn::Select": [
                 5,
                 {
                  "Fn::Split": [
                   "-",
                   {
                    "Fn::Select": [
                     6,
                     {
                      "Fn::Split": [
                       ":",
                       {
                        "Ref": "activedirectoryadminpasswordsecretB1F8F377"
                       }
                      ]
                     }
                    ]
                   }
                  ]
                 }
                ]
               },
               {
                "Fn::Select": [
                 6,
                 {
                  "Fn::Split": [
                   "-",
                   {
                    "Fn::Select": [
                     6,
                     {
                      "Fn::Split": [
                       ":",
                       {
                        "Ref": "activedirectoryadminpasswordsecretB1F8F377"
                       }
                      ]
                     }
                    ]
                   }
                  ]
                 }
                ]
               }
              ]
             ]
            },
            ")"
           ]
          ]
         },
         "echo \"Joining the AD domain...\"",
         "echo \"${adAdminPassword}\" | jq -r '.SecretString' | realm join -U admin@DIRECTORY.AMAZON-ECS-GMSA-LINUX.COM directory.amazon-ecs-gmsa-linux.com --verbose",
         "echo \"Restaring the ECS container instance...\"",
         "systemctl stop ecs",
         "systemctl start ecs"
        ]
       }
      }
     ]
    },
    "DocumentType": "Command"
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/domain-join-ssm-document-alt"
   }
  },
  "ecsclusterasgdomainjoinssmassociation": {
   "Type": "AWS::SSM::Association",
   "Properties": {
    "AssociationName": "amazon-ecs-gmsa-linux-AD-Domian-Join",
    "Name": {
     "Ref": "domainjoinssmdocument"
    },
    "Targets": [
     {
      "Key": "tag:ad-domain-join",
      "Values": [
       "amazon-ecs-gmsa-linux"
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg-domain-join-ssm-association"
   }
  },
  "ecsclusterasgInstanceSecurityGroup1C762339": {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
    "GroupDescription": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/InstanceSecurityGroup",
    "SecurityGroupEgress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow all outbound traffic by default",
      "IpProtocol": "-1"
     }
    ],
    "Tags": [
     {
      "Key": "ad-domain-join",
      "Value": "amazon-ecs-gmsa-linux"
     },
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg"
     }
    ],
    "VpcId": {
     "Ref": "vpcA2121C38"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/InstanceSecurityGroup/Resource"
   }
  },
  "ecsclusterasgInstanceRole373C335F": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "ec2.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AmazonSSMManagedInstanceCore"
       ]
      ]
     },
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/AmazonSSMDirectoryServiceAccess"
       ]
      ]
     }
    ],
    "Tags": [
     {
      "Key": "ad-domain-join",
      "Value": "amazon-ecs-gmsa-linux"
     },
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/InstanceRole/Resource"
   }
  },
  "ecsclusterasgInstanceRoleDefaultPolicy658DE35B": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "ecs:DeregisterContainerInstance",
        "ecs:RegisterContainerInstance",
        "ecs:Submit*"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "ecscluster7830E7B5",
         "Arn"
        ]
       }
      },
      {
       "Action": [
        "ecs:Poll",
        "ecs:StartTelemetrySession"
       ],
       "Condition": {
        "ArnEquals": {
         "ecs:cluster": {
          "Fn::GetAtt": [
           "ecscluster7830E7B5",
           "Arn"
          ]
         }
        }
       },
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": [
        "ecr:GetAuthorizationToken",
        "ecs:DiscoverPollEndpoint",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
       ],
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": [
        "secretsmanager:DescribeSecret",
        "secretsmanager:GetSecretValue"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Ref": "activedirectoryadminpasswordsecretB1F8F377"
        },
        {
         "Ref": "activedirectoryseamlessjoinsecret9100DD98"
        }
       ]
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "ecsclusterasgInstanceRoleDefaultPolicy658DE35B",
    "Roles": [
     {
      "Ref": "ecsclusterasgInstanceRole373C335F"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/InstanceRole/DefaultPolicy/Resource"
   }
  },
  "ecsclusterasgInstanceProfile58E291A6": {
   "Type": "AWS::IAM::InstanceProfile",
   "Properties": {
    "Roles": [
     {
      "Ref": "ecsclusterasgInstanceRole373C335F"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/InstanceProfile"
   }
  },
  "ecsclusterasgLaunchTemplate80B0A455": {
   "Type": "AWS::EC2::LaunchTemplate",
   "Properties": {
    "LaunchTemplateData": {
     "IamInstanceProfile": {
      "Arn": {
       "Fn::GetAtt": [
        "ecsclusterasgInstanceProfile58E291A6",
        "Arn"
       ]
      }
     },
     "ImageId": {
      "Ref": "SsmParameterValueawsserviceecsoptimizedamiamazonlinux2023recommendedimageidC96584B6F00A464EAD1953AFF4B05118Parameter"
     },
     "InstanceType": "t3.small",
     "KeyName": "gmsa",
     "Monitoring": {
      "Enabled": false
     },
     "SecurityGroupIds": [
      {
       "Fn::GetAtt": [
        "ecsclusterasgInstanceSecurityGroup1C762339",
        "GroupId"
       ]
      }
     ],
     "TagSpecifications": [
      {
       "ResourceType": "instance",
       "Tags": [
        {
         "Key": "ad-domain-join",
         "Value": "amazon-ecs-gmsa-linux"
        },
        {
         "Key": "Name",
         "Value": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/LaunchTemplate"
        }
       ]
      },
      {
       "ResourceType": "volume",
       "Tags": [
        {
         "Key": "ad-domain-join",
         "Value": "amazon-ecs-gmsa-linux"
        },
        {
         "Key": "Name",
         "Value": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/LaunchTemplate"
        }
       ]
      }
     ],
     "UserData": {
      "Fn::Base64": {
       "Fn::Join": [
        "",
        [
         "#!/bin/bash\necho \"ECS_GMSA_SUPPORTED=true\" >> /etc/ecs/ecs.config\necho \"sleeping for 80 secs to avoid RPM lock error...\"\nsleep 80s\ndnf install dotnet realmd oddjob oddjob-mkhomedir sssd adcli krb5-workstation samba-common-tools credentials-fetcher -y\nsystemctl enable credentials-fetcher\nsystemctl start credentials-fetcher\necho ECS_CLUSTER=",
         {
          "Ref": "ecscluster7830E7B5"
         },
         " >> /etc/ecs/ecs.config\nsudo iptables --insert FORWARD 1 --in-interface docker+ --destination 169.254.169.254/32 --jump DROP\nsudo service iptables save\necho ECS_AWSVPC_BLOCK_IMDS=true >> /etc/ecs/ecs.config"
        ]
       ]
      }
     }
    },
    "TagSpecifications": [
     {
      "ResourceType": "launch-template",
      "Tags": [
       {
        "Key": "ad-domain-join",
        "Value": "amazon-ecs-gmsa-linux"
       },
       {
        "Key": "Name",
        "Value": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/LaunchTemplate"
       }
      ]
     }
    ]
   },
   "DependsOn": [
    "ecsclusterasgInstanceRoleDefaultPolicy658DE35B",
    "ecsclusterasgInstanceRole373C335F"
   ],
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/LaunchTemplate/Resource"
   }
  },
  "ecsclusterasgASG059CF239": {
   "Type": "AWS::AutoScaling::AutoScalingGroup",
   "Properties": {
    "Cooldown": "60",
    "HealthCheckGracePeriod": 600,
    "HealthCheckType": "EC2",
    "LaunchTemplate": {
     "LaunchTemplateId": {
      "Ref": "ecsclusterasgLaunchTemplate80B0A455"
     },
     "Version": {
      "Fn::GetAtt": [
       "ecsclusterasgLaunchTemplate80B0A455",
       "LatestVersionNumber"
      ]
     }
    },
    "MaxSize": "2",
    "MinSize": "1",
    "Tags": [
     {
      "Key": "ad-domain-join",
      "PropagateAtLaunch": true,
      "Value": "amazon-ecs-gmsa-linux"
     },
     {
      "Key": "Name",
      "PropagateAtLaunch": true,
      "Value": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg"
     }
    ],
    "VPCZoneIdentifier": [
     {
      "Ref": "vpcPrivateSubnet1Subnet934893E8"
     },
     {
      "Ref": "vpcPrivateSubnet2Subnet7031C2BA"
     }
    ]
   },
   "UpdatePolicy": {
    "AutoScalingScheduledAction": {
     "IgnoreUnmodifiedGroupSizeProperties": true
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/ASG"
   }
  },
  "ecsclusterasgDrainECSHookFunctionServiceRoleB1D66D19": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ],
    "Tags": [
     {
      "Key": "ad-domain-join",
      "Value": "amazon-ecs-gmsa-linux"
     },
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/DrainECSHook/Function/ServiceRole/Resource"
   }
  },
  "ecsclusterasgDrainECSHookFunctionServiceRoleDefaultPolicy9ADD1416": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "ec2:DescribeHosts",
        "ec2:DescribeInstanceAttribute",
        "ec2:DescribeInstanceStatus",
        "ec2:DescribeInstances"
       ],
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": "autoscaling:CompleteLifecycleAction",
       "Effect": "Allow",
       "Resource": {
        "Fn::Join": [
         "",
         [
          "arn:",
          {
           "Ref": "AWS::Partition"
          },
          ":autoscaling:us-east-1:",
          {
           "Ref": "AWS::AccountId"
          },
          ":autoScalingGroup:*:autoScalingGroupName/",
          {
           "Ref": "ecsclusterasgASG059CF239"
          }
         ]
        ]
       }
      },
      {
       "Action": [
        "ecs:DescribeContainerInstances",
        "ecs:DescribeTasks",
        "ecs:ListTasks",
        "ecs:UpdateContainerInstancesState"
       ],
       "Condition": {
        "ArnEquals": {
         "ecs:cluster": {
          "Fn::GetAtt": [
           "ecscluster7830E7B5",
           "Arn"
          ]
         }
        }
       },
       "Effect": "Allow",
       "Resource": "*"
      },
      {
       "Action": [
        "ecs:ListContainerInstances",
        "ecs:SubmitContainerStateChange",
        "ecs:SubmitTaskStateChange"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "ecscluster7830E7B5",
         "Arn"
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "ecsclusterasgDrainECSHookFunctionServiceRoleDefaultPolicy9ADD1416",
    "Roles": [
     {
      "Ref": "ecsclusterasgDrainECSHookFunctionServiceRoleB1D66D19"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/DrainECSHook/Function/ServiceRole/DefaultPolicy/Resource"
   }
  },
  "ecsclusterasgDrainECSHookFunction0D34BF1E": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Code": {
     "ZipFile": "import boto3, json, os, time\n\necs = boto3.client('ecs')\nautoscaling = boto3.client('autoscaling')\n\n\ndef lambda_handler(event, context):\n  print(json.dumps(dict(event, ResponseURL='...')))\n  cluster = os.environ['CLUSTER']\n  snsTopicArn = event['Records'][0]['Sns']['TopicArn']\n  lifecycle_event = json.loads(event['Records'][0]['Sns']['Message'])\n  instance_id = lifecycle_event.get('EC2InstanceId')\n  if not instance_id:\n    print('Got event without EC2InstanceId: %s', json.dumps(dict(event, ResponseURL='...')))\n    return\n\n  instance_arn = container_instance_arn(cluster, instance_id)\n  print('Instance %s has container instance ARN %s' % (lifecycle_event['EC2InstanceId'], instance_arn))\n\n  if not instance_arn:\n    return\n\n  task_arns = container_instance_task_arns(cluster, instance_arn)\n\n  if task_arns:\n    print('Instance ARN %s has task ARNs %s' % (instance_arn, ', '.join(task_arns)))\n\n  while has_tasks(cluster, instance_arn, task_arns):\n    time.sleep(10)\n\n  try:\n    print('Terminating instance %s' % instance_id)\n    autoscaling.complete_lifecycle_action(\n        LifecycleActionResult='CONTINUE',\n        **pick(lifecycle_event, 'LifecycleHookName', 'LifecycleActionToken', 'AutoScalingGroupName'))\n  except Exception as e:\n    # Lifecycle action may have already completed.\n    print(str(e))\n\n\ndef container_instance_arn(cluster, instance_id):\n  \"\"\"Turn an instance ID into a container instance ARN.\"\"\"\n  arns = ecs.list_container_instances(cluster=cluster, filter='ec2InstanceId==' + instance_id)['containerInstanceArns']\n  if not arns:\n    return None\n  return arns[0]\n\ndef container_instance_task_arns(cluster, instance_arn):\n  \"\"\"Fetch tasks for a container instance ARN.\"\"\"\n  arns = ecs.list_tasks(cluster=cluster, containerInstance=instance_arn)['taskArns']\n  return arns\n\ndef has_tasks(cluster, instance_arn, task_arns):\n  \"\"\"Return True if the instance is running tasks for the given cluster.\"\"\"\n  instances = ecs.describe_container_instances(cluster=cluster, containerInstances=[instance_arn])['containerInstances']\n  if not instances:\n    return False\n  instance = instances[0]\n\n  if instance['status'] == 'ACTIVE':\n    # Start draining, then try again later\n    set_container_instance_to_draining(cluster, instance_arn)\n    return True\n\n  task_count = None\n\n  if task_arns:\n    # Fetch details for tasks running on the container instance\n    tasks = ecs.describe_tasks(cluster=cluster, tasks=task_arns)['tasks']\n    if tasks:\n      # Consider any non-stopped tasks as running\n      task_count = sum(task['lastStatus'] != 'STOPPED' for task in tasks) + instance['pendingTasksCount']\n\n  if not task_count:\n    # Fallback to instance task counts if detailed task information is unavailable\n    task_count = instance['runningTasksCount'] + instance['pendingTasksCount']\n\n  print('Instance %s has %s tasks' % (instance_arn, task_count))\n\n  return task_count > 0\n\ndef set_container_instance_to_draining(cluster, instance_arn):\n  ecs.update_container_instances_state(\n      cluster=cluster,\n      containerInstances=[instance_arn], status='DRAINING')\n\n\ndef pick(dct, *keys):\n  \"\"\"Pick a subset of a dict.\"\"\"\n  return {k: v for k, v in dct.items() if k in keys}\n"
    },
    "Environment": {
     "Variables": {
      "CLUSTER": {
       "Ref": "ecscluster7830E7B5"
      }
     }
    },
    "Handler": "index.lambda_handler",
    "Role": {
     "Fn::GetAtt": [
      "ecsclusterasgDrainECSHookFunctionServiceRoleB1D66D19",
      "Arn"
     ]
    },
    "Runtime": "python3.9",
    "Tags": [
     {
      "Key": "ad-domain-join",
      "Value": "amazon-ecs-gmsa-linux"
     },
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg"
     }
    ],
    "Timeout": 310
   },
   "DependsOn": [
    "ecsclusterasgDrainECSHookFunctionServiceRoleDefaultPolicy9ADD1416",
    "ecsclusterasgDrainECSHookFunctionServiceRoleB1D66D19"
   ],
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/DrainECSHook/Function/Resource"
   }
  },
  "ecsclusterasgDrainECSHookFunctionAllowInvokeamazonecsgmsalinuxinfrastructureecsclusterasgLifecycleHookDrainHookTopic49964F95856F3D43": {
   "Type": "AWS::Lambda::Permission",
   "Properties": {
    "Action": "lambda:InvokeFunction",
    "FunctionName": {
     "Fn::GetAtt": [
      "ecsclusterasgDrainECSHookFunction0D34BF1E",
      "Arn"
     ]
    },
    "Principal": "sns.amazonaws.com",
    "SourceArn": {
     "Ref": "ecsclusterasgLifecycleHookDrainHookTopic949ED8AE"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/DrainECSHook/Function/AllowInvoke:amazonecsgmsalinuxinfrastructureecsclusterasgLifecycleHookDrainHookTopic49964F95"
   }
  },
  "ecsclusterasgDrainECSHookFunctionTopicBBFE81D3": {
   "Type": "AWS::SNS::Subscription",
   "Properties": {
    "Endpoint": {
     "Fn::GetAtt": [
      "ecsclusterasgDrainECSHookFunction0D34BF1E",
      "Arn"
     ]
    },
    "Protocol": "lambda",
    "TopicArn": {
     "Ref": "ecsclusterasgLifecycleHookDrainHookTopic949ED8AE"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/DrainECSHook/Function/Topic/Resource"
   }
  },
  "ecsclusterasgLifecycleHookDrainHookTopic949ED8AE": {
   "Type": "AWS::SNS::Topic",
   "Properties": {
    "Tags": [
     {
      "Key": "ad-domain-join",
      "Value": "amazon-ecs-gmsa-linux"
     },
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/LifecycleHookDrainHook/Topic/Resource"
   }
  },
  "ecsclusterasgLifecycleHookDrainHookRole7C464B0B": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "autoscaling.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "Tags": [
     {
      "Key": "ad-domain-join",
      "Value": "amazon-ecs-gmsa-linux"
     },
     {
      "Key": "Name",
      "Value": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/LifecycleHookDrainHook/Role/Resource"
   }
  },
  "ecsclusterasgLifecycleHookDrainHookRoleDefaultPolicy90C4C0B3": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "sns:Publish",
       "Effect": "Allow",
       "Resource": {
        "Ref": "ecsclusterasgLifecycleHookDrainHookTopic949ED8AE"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "ecsclusterasgLifecycleHookDrainHookRoleDefaultPolicy90C4C0B3",
    "Roles": [
     {
      "Ref": "ecsclusterasgLifecycleHookDrainHookRole7C464B0B"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/LifecycleHookDrainHook/Role/DefaultPolicy/Resource"
   }
  },
  "ecsclusterasgLifecycleHookDrainHook14BB0B6F": {
   "Type": "AWS::AutoScaling::LifecycleHook",
   "Properties": {
    "AutoScalingGroupName": {
     "Ref": "ecsclusterasgASG059CF239"
    },
    "DefaultResult": "CONTINUE",
    "HeartbeatTimeout": 300,
    "LifecycleTransition": "autoscaling:EC2_INSTANCE_TERMINATING",
    "NotificationTargetARN": {
     "Ref": "ecsclusterasgLifecycleHookDrainHookTopic949ED8AE"
    },
    "RoleARN": {
     "Fn::GetAtt": [
      "ecsclusterasgLifecycleHookDrainHookRole7C464B0B",
      "Arn"
     ]
    }
   },
   "DependsOn": [
    "ecsclusterasgLifecycleHookDrainHookRoleDefaultPolicy90C4C0B3",
    "ecsclusterasgLifecycleHookDrainHookRole7C464B0B"
   ],
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg/LifecycleHookDrainHook/Resource"
   }
  },
  "ecsclusterasgcapacityprovider4923E7E5": {
   "Type": "AWS::ECS::CapacityProvider",
   "Properties": {
    "AutoScalingGroupProvider": {
     "AutoScalingGroupArn": {
      "Ref": "ecsclusterasgASG059CF239"
     },
     "ManagedScaling": {
      "Status": "ENABLED",
      "TargetCapacity": 100
     },
     "ManagedTerminationProtection": "DISABLED"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg-capacity-provider/ecs-cluster-asg-capacity-provider"
   }
  },
  "ecsclusterasgdomainjoinssmassociationalt": {
   "Type": "AWS::SSM::Association",
   "Properties": {
    "AssociationName": "amazon-ecs-gmsa-linux-AD-Domian-Join-Alt",
    "Name": {
     "Ref": "domainjoinssmdocumentalt"
    },
    "Targets": [
     {
      "Key": "tag:ad-domain-join",
      "Values": [
       "amazon-ecs-gmsa-linux"
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/ecs-cluster-asg-domain-join-ssm-association-alt"
   }
  },
  "domainjoinssmdocumentassociation39782141": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "ssm:CreateAssociation",
        "ssm:UpdateAssociation"
       ],
       "Effect": "Allow",
       "Resource": "*"
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "domainjoinssmdocumentassociation39782141",
    "Roles": [
     {
      "Ref": "ecsclusterasgInstanceRole373C335F"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/domain-join-ssm-document-association/Resource"
   }
  },
  "credspecssmparameter4DB3D748": {
   "Type": "AWS::SSM::Parameter",
   "Properties": {
    "AllowedPattern": ".*",
    "Description": "gMSA CredSpec",
    "Name": "/amazon-ecs-gmsa-linux/credspec",
    "Tier": "Standard",
    "Type": "String",
    "Value": "RUN Generate-CredSpec.ps1 to populate this parameter"
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/credspec-ssm-parameter/Resource"
   }
  },
  "credspecs3bucket2AC0FC3A": {
   "Type": "AWS::S3::Bucket",
   "Properties": {
    "BucketEncryption": {
     "ServerSideEncryptionConfiguration": [
      {
       "ServerSideEncryptionByDefault": {
        "SSEAlgorithm": "AES256"
       }
      }
     ]
    },
    "PublicAccessBlockConfiguration": {
     "BlockPublicAcls": true,
     "BlockPublicPolicy": true,
     "IgnorePublicAcls": true,
     "RestrictPublicBuckets": true
    }
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/credspec-s3-bucket/Resource"
   }
  },
  "credspecs3bucketPolicy3F07CE55": {
   "Type": "AWS::S3::BucketPolicy",
   "Properties": {
    "Bucket": {
     "Ref": "credspecs3bucket2AC0FC3A"
    },
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "s3:*",
       "Condition": {
        "Bool": {
         "aws:SecureTransport": "false"
        }
       },
       "Effect": "Deny",
       "Principal": {
        "AWS": "*"
       },
       "Resource": [
        {
         "Fn::GetAtt": [
          "credspecs3bucket2AC0FC3A",
          "Arn"
         ]
        },
        {
         "Fn::Join": [
          "",
          [
           {
            "Fn::GetAtt": [
             "credspecs3bucket2AC0FC3A",
             "Arn"
            ]
           },
           "/*"
          ]
         ]
        }
       ]
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/credspec-s3-bucket/Policy/Resource"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/2VTXY/iMAz8Lfcecgenk/YeOdgPJPa2ArSvJ2MMm6VNqjgBoar//dwUaFmePJ7YzXicjvRw9Fv/+AZHHuBmP8jNWlfLALhXQv2rCEe6ei9RTbb2PZuoLK5zg8u4thQarkMLFwOtYJ1Tx3fcmNmhgWCcvRY34HGWNeEvhGcIdISTyrw5COw+PLOBvOBLQavknI2DaP0oyAb1lLvj3O2a8x6cvkyyt7K5l8+dPaavakkYvQmnZ+9imUa4IeYQLX6sqChzaKXfMrUyUOhq4dr5U8yceJUEd2hmOYBFyrzbmlzacrdjXYna68UXXCsm9BS4AAs78rKYlJ/FCarVxnjC4PyJyR8MkpazV4PesduG8VQxF80+vbG7DDwUJF4mQf1k6jAmCwX3LKkVoUib5JHPhfdwAiWgmCTjHMyGfK+d1Zh3X89T6xeuVhCDY4RcVOpqLMmyTa6W3HFzsyU8YU4vzu2TaX1CXIVivQFdPcmOLo+ujzPyhWFOU7KVKeW9MXpTXgpu8pUrTfoFEpCOn7r6E3Hf7uKM2tBtup/XtVoQu+gxvY63GMoY7vZwKamVdRvSn/z9MHzQw1/yf36yMQMfbTAF6UUb/wPGnWIPvAMAAA=="
   },
   "Metadata": {
    "aws:cdk:path": "amazon-ecs-gmsa-linux-infrastructure/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "ActiveDirectoryAdminPasswordSecretARN": {
   "Value": {
    "Ref": "activedirectoryadminpasswordsecretB1F8F377"
   }
  },
  "ECSAutoScalingGroupName": {
   "Value": {
    "Ref": "ecsclusterasgASG059CF239"
   }
  },
  "ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271": {
   "Value": {
    "Ref": "vpcPrivateSubnet1Subnet934893E8"
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputRefvpcPrivateSubnet1Subnet934893E8236E2271"
   }
  },
  "ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE": {
   "Value": {
    "Ref": "vpcPrivateSubnet2Subnet7031C2BA"
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputRefvpcPrivateSubnet2Subnet7031C2BA60DCB1EE"
   }
  },
  "ExportsOutputRefvpcA2121C384D1B3CDE": {
   "Value": {
    "Ref": "vpcA2121C38"
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputRefvpcA2121C384D1B3CDE"
   }
  },
  "ExportsOutputFnGetAttecsclusterasgInstanceSecurityGroup1C762339GroupIdC6268B2B": {
   "Value": {
    "Fn::GetAtt": [
     "ecsclusterasgInstanceSecurityGroup1C762339",
     "GroupId"
    ]
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputFnGetAttecsclusterasgInstanceSecurityGroup1C762339GroupIdC6268B2B"
   }
  },
  "ExportsOutputFnGetAttactivedirectoryAlias6D90A2A9": {
   "Value": {
    "Fn::GetAtt": [
     "activedirectory",
     "Alias"
    ]
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputFnGetAttactivedirectoryAlias6D90A2A9"
   }
  },
  "ExportsOutputRefactivedirectoryadminpasswordsecretB1F8F377D9936D0C": {
   "Value": {
    "Ref": "activedirectoryadminpasswordsecretB1F8F377"
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputRefactivedirectoryadminpasswordsecretB1F8F377D9936D0C"
   }
  },
  "ExportsOutputRefcredfetcheridentitysecretFEBFB2F237ACC848": {
   "Value": {
    "Ref": "credfetcheridentitysecretFEBFB2F2"
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputRefcredfetcheridentitysecretFEBFB2F237ACC848"
   }
  },
  "ExportsOutputRefcredspecssmparameter4DB3D74868B44AFE": {
   "Value": {
    "Ref": "credspecssmparameter4DB3D748"
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputRefcredspecssmparameter4DB3D74868B44AFE"
   }
  },
  "ExportsOutputFnGetAttcredspecs3bucket2AC0FC3AArnCFB4DF8C": {
   "Value": {
    "Fn::GetAtt": [
     "credspecs3bucket2AC0FC3A",
     "Arn"
    ]
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputFnGetAttcredspecs3bucket2AC0FC3AArnCFB4DF8C"
   }
  },
  "ExportsOutputRefvpcPublicSubnet1Subnet2E65531ECCB85041": {
   "Value": {
    "Ref": "vpcPublicSubnet1Subnet2E65531E"
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputRefvpcPublicSubnet1Subnet2E65531ECCB85041"
   }
  },
  "ExportsOutputRefcredspecs3bucket2AC0FC3A928DF580": {
   "Value": {
    "Ref": "credspecs3bucket2AC0FC3A"
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputRefcredspecs3bucket2AC0FC3A928DF580"
   }
  },
  "ExportsOutputRefdomainjoinssmdocumentA1B66A26": {
   "Value": {
    "Ref": "domainjoinssmdocument"
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputRefdomainjoinssmdocumentA1B66A26"
   }
  },
  "ExportsOutputRefvpcPublicSubnet2Subnet009B674FB900C242": {
   "Value": {
    "Ref": "vpcPublicSubnet2Subnet009B674F"
   },
   "Export": {
    "Name": "amazon-ecs-gmsa-linux-infrastructure:ExportsOutputRefvpcPublicSubnet2Subnet009B674FB900C242"
   }
  }
 },
 "Parameters": {
  "SsmParameterValueawsserviceecsoptimizedamiamazonlinux2023recommendedimageidC96584B6F00A464EAD1953AFF4B05118Parameter": {
   "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
   "Default": "/aws/service/ecs/optimized-ami/amazon-linux-2023/recommended/image_id"
  },
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}